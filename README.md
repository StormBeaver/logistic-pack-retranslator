Проект выполнен в рамках курса [Route256 2021 OZON](https://rutracker.org/forum/viewtopic.php?t=6201055)

#### Репозиторий с заданиями
https://github.com/ozonmp/omp-docs

# О проекте
Репозиторий является частью проекта [Logistic-pack-api](https://github.com/StormBeaver/logistic-pack-api)

## logistic-pack-retranslator

logistic-pack-retranslator состоит из:

* `consumer`
* `producer`
* `sender`

Термины `consumer` и `producer` употреблены по отношению к внешнему миру (используемой в logistic-pack-api базе данных).

### Consumer
Через время, установленное в config-файле горутины `consumer`'а "забирают" из таблицы `packs_events` данные о событии репозитория на обработку: читают записи и изменяют значение в столбце `lock` на `True`.Полученные данные отправляются в буферизированный канал `events`. Порядок действий при работе `consumer`'a позволяет избежать потерь сообщений, реализуя гарантию доставки `at least once`.

### Producer
Горутины `producer`'а читают данные из канала `events` и пытаются отправить их в кафка-топик вызывая метод `send` - `sender`'а. В зависимости от результата попытки отправки в кафка-топик, данные разделяются на те, которые следует удалить из таблицы `packs_events` в случае успешной отправки, либо установить значение в столбце `lock` на `False` для повторной попытки отправить это событие позднее.

### Sender 
Sender сериализует данные о событиях в json и отправляет в топик в зависимости от типа события, а именно `created`, `updated` или `removed`. 

## Метрики
Сервис собирают метрики с помощью [прометей-клиента](https://github.com/prometheus/client_golang).

Ретранслятор собирает одну метрику
* `logistic_pack_retranslator_events_count` _Gauge_ — количество событий, обрабатываемых в текущий момент в ретрансляторе

Метрики ретранслятора доступны на `:9101/metrics`

## Docker

Описан докерфайл для образа ретранслятора.

## Makefile

В мейкфайле описаны команды для локального запуска приложения, сборки докер-образа, и его запуска.